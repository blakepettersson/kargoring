apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kargo
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - name: guestbook
            repoUrl: https://github.com/blakepettersson/guestbook.git
            branch: main
            image: ghcr.io/dhpup/guestbook
  template:
    metadata:
      name: 'kargo-{{name}}'
    spec:
      project: kargo-demo
      source:
        repoURL: https://github.com/blakepettersson/kargo-boilerplate.git
        path: .
        helm:
          valuesObject:
            nameOverride: '{{name}}'
            warehouse:
              subscriptions:
                - git:
                    repoURL: '{{ repoUrl }}'
                    branch: '{{ branch }}'
                - image:
                    repoURL: '{{ image }}'
            project:
              promotionPolicies:
                - stage: dev
                  autoPromotionEnabled: true
                - stage: test
                  autoPromotionEnabled: true
                - stage: preview
                  autoPromotionEnabled: true
                - stage: prod-uswest
                  autoPromotionEnabled: true
                - stage: prod-euwest
                  autoPromotionEnabled: true
            stages:
              - name: dev
                annotations:
                  kargo.akuity.io/color: purple
                subscriptions:
                  warehouse: '{{name}}'
                promotionMechanisms:
                  gitRepoUpdates:
                    - repoURL: '{{ repoUrl }}'
                      writeBranch: stage/dev
                      helm:
                        images:
                          - image: '{{ image }}'
                            valuesFilePath: values-dev.yaml
                            key: image.name # Update this key to reference the new image version
                            value: ImageAndTag
                  argoCDAppUpdates:
                    - appName: '{{name}}-dev'
                      appNamespace: argocd
              - name: test
                annotations:
                  kargo.akuity.io/color: purple
                subscriptions:
                  upstreamStages:
                    - name: dev
                promotionMechanisms:
                  gitRepoUpdates:
                    - repoURL: '{{ repoUrl }}'
                      writeBranch: stage/test
                      helm:
                        images:
                          - image: '{{ image }}'
                            valuesFilePath: values-test.yaml
                            key: image.name # Update this key to reference the new image version
                            value: ImageAndTag
                  argoCDAppUpdates:
                    - appName: '{{name}}-test'
                      appNamespace: argocd
              - name: preview
                annotations:
                  kargo.akuity.io/color: blue
                subscriptions:
                  upstreamStages:
                    - name: test
                promotionMechanisms:
                  gitRepoUpdates:
                    - repoURL: '{{ repoUrl }}'
                      writeBranch: stage/preview
                      helm:
                        images:
                          - image: '{{ image }}'
                            valuesFilePath: values-preview.yaml
                            key: image.name # Update this key to reference the new image version
                            value: ImageAndTag
                  argoCDAppUpdates:
                    - appName: '{{name}}-preview'
                      appNamespace: argocd
              - name: prod-euwest
                annotations:
                  kargo.akuity.io/color: cyan
                subscriptions:
                  upstreamStages:
                    - name: preview
                promotionMechanisms:
                  gitRepoUpdates:
                    - repoURL: '{{ repoUrl }}'
                      writeBranch: stage/prod-euwest
                      helm:
                        images:
                          - image: '{{ image }}'
                            valuesFilePath: values-prod-euwest.yaml
                            key: image.name # Update this key to reference the new image version
                            value: ImageAndTag
                  argoCDAppUpdates:
                    - appName: '{{name}}-prod-euwest'
                      appNamespace: argocd
              - name: prod-uswest
                annotations:
                  kargo.akuity.io/color: pink
                subscriptions:
                  upstreamStages:
                    - name: preview
                promotionMechanisms:
                  gitRepoUpdates:
                    - repoURL: '{{ repoUrl }}'
                      writeBranch: stage/prod-uswest
                      helm:
                        images:
                          - image: '{{ image }}'
                            valuesFilePath: values-prod-uswest.yaml
                            key: image.name # Update this key to reference the new image version
                            value: ImageAndTag
                  argoCDAppUpdates:
                    - appName: '{{name}}-prod-uswest'
                      appNamespace: argocd
      destination:
        name: kargo1
      syncPolicy:
        automated: {}
        syncOptions:
        - CreateNamespace=true
